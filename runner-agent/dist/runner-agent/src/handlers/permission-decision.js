/**
 * Permission Decision Handler
 *
 * Handles permission_decision WebSocket messages from Discord bot.
 * This is the new permission system that supports scopes and suggestions.
 */
/**
 * Handle permission decision from Discord bot
 */
export async function handlePermissionDecision(data, deps) {
    const { cliSessions, wsManager } = deps;
    const { requestId, behavior, scope, updatedPermissions, customMessage } = data;
    console.log(`[PermissionDecision] Received decision for request ${requestId}: ${behavior}`);
    // The requestId is generated by discord-bot and needs to be mapped to a session
    // The format is typically: sessionId-timestamp
    // We need to find the session that corresponds to this request
    // Try to extract sessionId from requestId
    // The discord-bot creates requestId as: sessionId + '-' + timestamp
    // Ideally use the explicit sessionId if provided
    let sessionId = data.sessionId;
    if (!sessionId) {
        // Fallback: This is risky for UUIDs but kept for legacy
        sessionId = requestId.split('-')[0];
        // If it looks like a short hash (8 chars), it might be right.
        // If it's part of a UUID (8 chars), it might conform to short ID lookup logic?
    }
    // Try explicit lookup first (full ID)
    let session = cliSessions.get(sessionId);
    // If not found, tries by short ID if sessionId is length 8?
    // Or if split returned just one part.
    if (!session && sessionId && sessionId.length === 8) {
        // Maybe iteration happens elsewhere? No.
    }
    if (!session) {
        console.error(`[PermissionDecision] Session not found for requestId: ${requestId}`);
        // Send negative acknowledgment
        wsManager.send({
            type: 'permission_decision_ack',
            data: {
                requestId,
                sessionId: sessionId || '',
                success: false,
                error: 'Session not found',
                timestamp: new Date().toISOString()
            }
        });
        return;
    }
    // Check if this is a ClaudeSDKPlugin session with sendPermissionDecision method
    if ('sendPermissionDecision' in session && typeof session.sendPermissionDecision === 'function') {
        let success = false;
        let error;
        try {
            await session.sendPermissionDecision(requestId, {
                behavior,
                scope,
                updatedPermissions,
                updatedInput: undefined, // Not provided by discord-bot in this flow
                message: customMessage
            });
            success = true;
            console.log(`[PermissionDecision] Sent decision to session ${sessionId}`);
        }
        catch (err) {
            error = err instanceof Error ? err.message : String(err);
            console.error(`[PermissionDecision] Failed to send decision to session ${sessionId}:`, error);
        }
        // Send acknowledgment back to bot
        wsManager.send({
            type: 'permission_decision_ack',
            data: {
                requestId,
                sessionId,
                success,
                error,
                timestamp: new Date().toISOString()
            }
        });
    }
    else {
        console.error(`[PermissionDecision] Session ${sessionId} does not support sendPermissionDecision`);
        // Send negative acknowledgment
        wsManager.send({
            type: 'permission_decision_ack',
            data: {
                requestId,
                sessionId,
                success: false,
                error: 'Session does not support sendPermissionDecision',
                timestamp: new Date().toISOString()
            }
        });
    }
}
